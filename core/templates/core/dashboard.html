{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-[1800px] mx-auto space-y-6 animate-fade-in-down relative">

    {% if transitorio.vol > 0 %}
    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-600/30 rounded-lg p-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-600/20 text-amber-600 dark:text-amber-500 flex items-center justify-center text-xl animate-pulse">
                <i class="fa-solid fa-truck-ramp-box"></i>
            </div>
            <div>
                <h3 class="text-amber-700 dark:text-amber-500 font-bold text-sm uppercase tracking-wide">Aguardando Armazenagem</h3>
                <p class="text-xs text-amber-600/70 dark:text-slate-400">Itens em áreas temporárias (Doca/Transitório).</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-2xl font-black text-amber-800 dark:text-white">{{ transitorio.vol|floatformat:0 }} <span class="text-sm font-normal text-amber-600/70 dark:text-slate-500">vol</span></p>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        
        <a href="?categoria={% if filtro_categoria == 'PA' %}{% else %}PA{% endif %}" class="block group cursor-pointer">
            <div class="bg-white dark:bg-slate-800 rounded-xl border-t-4 {% if filtro_categoria == 'PA' %}border-emerald-400 ring-2 ring-emerald-500/50{% else %}border-emerald-500 hover:border-emerald-400{% endif %} shadow-lg p-5 border-x border-b border-gray-100 dark:border-slate-700 transition-all hover:-translate-y-1">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-emerald-600 dark:text-emerald-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-beer-mug-empty"></i> P.A.
                            {% if filtro_categoria == 'PA' %}<i class="fa-solid fa-check-circle text-emerald-500 animate-pulse"></i>{% endif %}
                        </h2>
                        <p class="text-[9px] text-slate-400 dark:text-slate-500">Venda (Cerveja/Refri)</p>
                    </div>
                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ stats.PA.vol|floatformat:0 }} <span class="text-[10px] font-normal text-slate-400">vol</span></p>
                </div>
                
                <div class="bg-gray-50 dark:bg-slate-900/50 rounded-lg p-2 border border-gray-100 dark:border-slate-700/50">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Top Item</p>
                    {% if stats.PA.maior_item %}
                        <p class="text-xs font-bold text-slate-700 dark:text-slate-200 truncate" title="{{ stats.PA.maior_item.descricao }}">{{ stats.PA.maior_item.descricao }}</p>
                    {% else %}
                        <p class="text-xs text-slate-400 italic">Sem estoque</p>
                    {% endif %}
                </div>
            </div>
        </a>

        <a href="?categoria={% if filtro_categoria == 'INSUMO' %}{% else %}INSUMO{% endif %}" class="block group cursor-pointer">
            <div class="bg-white dark:bg-slate-800 rounded-xl border-t-4 {% if filtro_categoria == 'INSUMO' %}border-blue-400 ring-2 ring-blue-500/50{% else %}border-blue-500 hover:border-blue-400{% endif %} shadow-lg p-5 border-x border-b border-gray-100 dark:border-slate-700 transition-all hover:-translate-y-1">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-blue-600 dark:text-blue-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-boxes-packing"></i> INSUMO
                            {% if filtro_categoria == 'INSUMO' %}<i class="fa-solid fa-check-circle text-blue-500 animate-pulse"></i>{% endif %}
                        </h2>
                        <p class="text-[9px] text-slate-400 dark:text-slate-500">Matéria Prima</p>
                    </div>
                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ stats.INSUMO.vol|floatformat:0 }} <span class="text-[10px] font-normal text-slate-400">vol</span></p>
                </div>
                
                <div class="bg-gray-50 dark:bg-slate-900/50 rounded-lg p-2 border border-gray-100 dark:border-slate-700/50">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Top Item</p>
                    {% if stats.INSUMO.maior_item %}
                        <p class="text-xs font-bold text-slate-700 dark:text-slate-200 truncate" title="{{ stats.INSUMO.maior_item.descricao }}">{{ stats.INSUMO.maior_item.descricao }}</p>
                    {% else %}
                        <p class="text-xs text-slate-400 italic">Sem estoque</p>
                    {% endif %}
                </div>
            </div>
        </a>

        <a href="?categoria={% if filtro_categoria == 'RPM' %}{% else %}RPM{% endif %}" class="block group cursor-pointer">
            <div class="bg-white dark:bg-slate-800 rounded-xl border-t-4 {% if filtro_categoria == 'RPM' %}border-amber-400 ring-2 ring-amber-500/50{% else %}border-amber-500 hover:border-amber-400{% endif %} shadow-lg p-5 border-x border-b border-gray-100 dark:border-slate-700 transition-all hover:-translate-y-1">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-amber-600 dark:text-amber-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-bottle-droplet"></i> RPM
                            {% if filtro_categoria == 'RPM' %}<i class="fa-solid fa-check-circle text-amber-500 animate-pulse"></i>{% endif %}
                        </h2>
                        <p class="text-[9px] text-slate-400 dark:text-slate-500">Caixas / Garrafas</p>
                    </div>
                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ stats.RPM.vol|floatformat:0 }} <span class="text-[10px] font-normal text-slate-400">vol</span></p>
                </div>
                
                <div class="bg-gray-50 dark:bg-slate-900/50 rounded-lg p-2 border border-gray-100 dark:border-slate-700/50">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Top Item</p>
                    {% if stats.RPM.maior_item %}
                        <p class="text-xs font-bold text-slate-700 dark:text-slate-200 truncate" title="{{ stats.RPM.maior_item.descricao }}">{{ stats.RPM.maior_item.descricao }}</p>
                    {% else %}
                        <p class="text-xs text-slate-400 italic">Sem estoque</p>
                    {% endif %}
                </div>
            </div>
        </a>

        <a href="?categoria={% if filtro_categoria == 'PBR' %}{% else %}PBR{% endif %}" class="block group cursor-pointer">
            <div class="bg-white dark:bg-slate-800 rounded-xl border-t-4 {% if filtro_categoria == 'PBR' %}border-purple-400 ring-2 ring-purple-500/50{% else %}border-purple-500 hover:border-purple-400{% endif %} shadow-lg p-5 border-x border-b border-gray-100 dark:border-slate-700 transition-all hover:-translate-y-1">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-purple-600 dark:text-purple-500 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-pallet"></i> PALETES
                            {% if filtro_categoria == 'PBR' %}<i class="fa-solid fa-check-circle text-purple-500 animate-pulse"></i>{% endif %}
                        </h2>
                        <p class="text-[9px] text-slate-400 dark:text-slate-500">PBR / Chapatex</p>
                    </div>
                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ stats.PBR.vol|floatformat:1 }} <span class="text-[10px] font-normal text-slate-400">pos</span></p>
                </div>
                
                <div class="bg-gray-50 dark:bg-slate-900/50 rounded-lg p-2 border border-gray-100 dark:border-slate-700/50">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Top Item</p>
                    {% if stats.PBR.maior_item %}
                        <p class="text-xs font-bold text-slate-700 dark:text-slate-200 truncate" title="{{ stats.PBR.maior_item.descricao }}">{{ stats.PBR.maior_item.descricao }}</p>
                    {% else %}
                        <p class="text-xs text-slate-400 italic">Sem estoque</p>
                    {% endif %}
                </div>
            </div>
        </a>

    </div>

    <div class="bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700 p-2 flex flex-col md:flex-row gap-4 justify-between items-center shadow-md transition-colors">
        
        <div class="flex gap-2 items-center overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
            <a href="{% url 'home' %}" class="px-4 py-2 rounded text-xs font-bold transition-all border border-transparent {% if not galpao %}bg-slate-200 text-slate-900 dark:bg-slate-100 dark:text-slate-900{% else %}text-slate-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:border-gray-200 dark:hover:border-slate-600{% endif %}">
                GLOBAL
            </a>
            <div class="h-4 w-px bg-gray-300 dark:bg-slate-600"></div>
            {% for gp_num in lista_galpoes %}
            <a href="{% url 'dashboard' gp_num %}" class="px-3 py-2 rounded text-xs font-bold transition-all border border-transparent {% if galpao == gp_num %}bg-blue-600 text-white shadow-md{% else %}text-slate-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:border-gray-200 dark:hover:border-slate-600{% endif %}">
                GP {{ gp_num }}
            </a>
            {% endfor %}
        </div>

        <form method="get" class="flex gap-2 w-full md:w-auto">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                <input type="text" name="produto" value="{{ filtro_produto }}" placeholder="Buscar SKU ou Nome..." 
                       class="w-full md:w-64 bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-slate-800 dark:text-white text-xs rounded pl-8 pr-3 py-2 focus:border-blue-500 focus:bg-white dark:focus:bg-slate-950 outline-none transition-colors">
            </div>
            
            <select name="status" class="bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-slate-800 dark:text-white text-xs rounded px-3 py-2 focus:border-blue-500 outline-none transition-colors">
                <option value="">Status: Todos</option>
                
                <optgroup label="Qualidade">
                    <option value="ESTOQUE" {% if filtro_status == 'ESTOQUE' %}selected{% endif %}>Disponível</option>
                    <option value="BLOQUEADO" {% if filtro_status == 'BLOQUEADO' %}selected{% endif %}>Bloqueado</option>
                    <option value="DESCARTE" {% if filtro_status == 'DESCARTE' %}selected{% endif %}>Descarte</option>
                </optgroup>

                <optgroup label="Ocupação / Tipo">
                    <option value="vazia" {% if filtro_status == 'vazia' %}selected{% endif %}>Ruas Vazias</option>
                    <option value="cheia" {% if filtro_status == 'cheia' %}selected{% endif %}>Ruas Cheias</option>
                    <option value="misto" {% if filtro_status == 'misto' %}selected{% endif %}>⚠️ Ruas Mistas (Misturadas)</option>
                </optgroup>
            </select>

            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition-colors shadow-md hover:shadow-lg">
                Filtrar
            </button>
        </form>
    </div>

    <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-4 overflow-x-auto shadow-2xl transition-colors">
        
        <div class="flex gap-6 mb-4 text-[10px] uppercase font-bold text-slate-400 dark:text-slate-400 border-b border-gray-100 dark:border-slate-700 pb-2">
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-200 dark:bg-slate-600 border border-slate-300 dark:border-transparent"></div> Vazio</div>
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Disponível</div>
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Ocupado (>85%)</div>
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-red-600"></div> Crítico/Lotado</div>
        </div>

        <div class="min-w-[1000px]">
            {% if not mapa %}
                <div class="text-center py-12 text-slate-400">
                    {% if filtro_categoria %}
                        <p>Nenhuma rua encontrada com produtos da categoria <span class="font-bold text-slate-200">{{ filtro_categoria }}</span>.</p>
                        <a href="{% url 'home' %}" class="inline-block mt-2 text-xs text-blue-400 hover:text-blue-300">Limpar Filtros</a>
                    {% else %}
                        <p>Nenhuma rua para exibir.</p>
                    {% endif %}
                </div>
            {% else %}
                <div class="grid grid-cols-12 gap-1.5">
                    {% for rua in mapa %}
                    
                    <div onclick='abrirModal("{{ rua.codigo }}", {{ rua.json_detalhes|safe }})' 
                         class="relative border rounded p-1.5 hover:scale-105 transition-transform cursor-pointer group h-20 flex flex-col justify-between overflow-hidden
                         {% if 'bg-slate-900' in rua.cor_bg %} bg-slate-50 dark:bg-slate-900/50 border-slate-200 dark:border-slate-800
                         {% elif 'bg-red' in rua.cor_bg %} bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-900/50
                         {% elif 'bg-blue' in rua.cor_bg %} bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700/50
                         {% elif 'bg-emerald' in rua.cor_bg %} bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-800/50
                         {% else %} {{ rua.cor_bg }} {% endif %}"
                         title="Clique para ver detalhes">
                        
                        <div class="flex justify-between items-start z-10 relative">
                            <span class="text-[10px] font-bold text-slate-700 dark:text-slate-300 leading-none">{{ rua.codigo }}</span>
                            <span class="text-[9px] font-bold {{ rua.cor_texto }}">{{ rua.porcentagem }}%</span>
                        </div>

                        <div class="z-10 relative">
                            <p class="text-[9px] text-slate-500 dark:text-slate-400 truncate w-full font-medium">{{ rua.produto }}</p>
                        </div>

                        <div class="absolute bottom-0 left-0 w-full {{ rua.cor_bar }} opacity-20" style="height: {{ rua.porcentagem }}%;"></div>
                        <div class="absolute bottom-0 left-0 w-full h-0.5 {{ rua.cor_bar }}"></div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="text-right text-[10px] text-slate-400 dark:text-slate-600">
        WMS Lusitana v2.0 | Atualizado: {% now "H:i" %}
    </div>

</div>

<div id="modalRaioX" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity" onclick="fecharModal()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-slate-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-slate-700">
                
                <div class="bg-slate-900 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-slate-700">
                    <h3 class="text-base font-bold leading-6 text-white flex items-center gap-2" id="modal-title">
                        <i class="fa-solid fa-magnifying-glass-location text-emerald-500"></i> Raio-X: Rua <span id="modalRuaTitulo" class="text-emerald-400">...</span>
                    </h3>
                    <button type="button" onclick="fecharModal()" class="text-slate-400 hover:text-white transition">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="px-4 py-4 sm:p-6 bg-slate-800/50">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-900">
                                <tr>
                                    <th scope="col" class="py-3 pl-4 pr-3 text-left text-[10px] font-bold uppercase tracking-wide text-slate-400 sm:pl-6">Produto</th>
                                    <th scope="col" class="px-3 py-3 text-left text-[10px] font-bold uppercase tracking-wide text-slate-400">Lote</th>
                                    <th scope="col" class="px-3 py-3 text-center text-[10px] font-bold uppercase tracking-wide text-slate-400">Qtd</th>
                                    <th scope="col" class="px-3 py-3 text-center text-[10px] font-bold uppercase tracking-wide text-slate-400">Validade</th>
                                    <th scope="col" class="px-3 py-3 text-center text-[10px] font-bold uppercase tracking-wide text-slate-400">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDetalhes" class="divide-y divide-slate-700 bg-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-slate-900 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-700">
                    <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto" onclick="fecharModal()">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function abrirModal(rua, detalhes) {
        document.getElementById('modalRuaTitulo').innerText = rua;
        const tbody = document.getElementById('tabelaDetalhes');
        tbody.innerHTML = '';

        if (!detalhes || detalhes.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-sm text-slate-500 italic">Rua Vazia</td></tr>`;
        } else {
            detalhes.forEach(item => {
                // Define a cor do Status (Coluna H)
                let statusClass = "bg-slate-700 text-slate-300"; // Padrão
                let statusIcon = "";
                
                if (item.status.includes('ESTOQUE') || item.status.includes('DISPONIVEL')) {
                    statusClass = "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
                    statusIcon = '<i class="fa-solid fa-check-circle mr-1"></i>';
                } else if (item.status.includes('BLOQUEADO')) {
                    statusClass = "bg-red-500/10 text-red-400 border border-red-500/20";
                    statusIcon = '<i class="fa-solid fa-ban mr-1"></i>';
                } else if (item.status.includes('DESCARTE')) {
                    statusClass = "bg-slate-950 text-slate-400 border border-slate-700 line-through";
                    statusIcon = '<i class="fa-solid fa-trash mr-1"></i>';
                }

                const row = `
                    <tr class="hover:bg-slate-700/50 transition">
                        <td class="whitespace-nowrap py-3 pl-4 pr-3 text-xs font-medium text-white sm:pl-6">
                            <p class="truncate w-48 font-bold" title="${item.produto}">${item.produto}</p>
                            <p class="text-[10px] text-slate-500 font-mono">${item.sku}</p>
                        </td>
                        <td class="whitespace-nowrap px-3 py-3 text-xs text-slate-300 font-mono">${item.lote}</td>
                        <td class="whitespace-nowrap px-3 py-3 text-xs text-white font-bold text-center">${item.qtd}</td>
                        <td class="whitespace-nowrap px-3 py-3 text-xs text-amber-500 font-mono text-center">${item.validade}</td>
                        <td class="whitespace-nowrap px-3 py-3 text-[10px] font-bold text-center">
                            <span class="inline-flex items-center rounded-md px-2 py-1 ring-1 ring-inset ring-white/10 ${statusClass}">
                                ${statusIcon} ${item.status}
                            </span>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        document.getElementById('modalRaioX').classList.remove('hidden');
    }

    function fecharModal() {
        document.getElementById('modalRaioX').classList.add('hidden');
    }

    // Fecha com ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            fecharModal();
        }
    });
</script>

{% endblock %}